<!-- public/dashboard.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>

  <!-- Tailwind (dev) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SweetAlert2 -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- DataTables + jQuery -->
  <link rel="stylesheet"
        href="https://cdn.datatables.net/1.13.4/css/dataTables.tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.tailwind.min.js"></script>

  <!-- Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- --------------- Barra superior ---------------- -->
  <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">ðŸ“Š Dashboard Puerto Games</h1>
    <div>
      <span id="saludo" class="mr-4"></span>
      <button id="logout"
              class="bg-red-500 px-3 py-1 rounded hover:bg-red-600">Salir</button>
    </div>
  </header>

  <!-- --------------- Contenido ---------------- -->
  <main class="flex-1 p-6 space-y-8">

    <!-- ---------- Grid de grÃ¡ficos ---------- -->
    <section class="grid gap-8 md:grid-cols-2 grid-cols-1">
      <div class="bg-white shadow rounded-xl p-4">
        <h2 class="font-semibold mb-4 text-center">Stock por plataforma</h2>
        <div class="h-72"><canvas id="grafPlata" class="w-full h-full"></canvas></div>
      </div>

      <div class="bg-white shadow rounded-xl p-4">
        <h2 class="font-semibold mb-4 text-center">Stock por gÃ©nero</h2>
        <div class="h-72"><canvas id="grafGenero" class="w-full h-full"></canvas></div>
      </div>

      <div class="bg-white shadow rounded-xl p-4">
        <h2 class="font-semibold mb-4 text-center">PrÃ©stamos: activos vs devueltos</h2>
        <div class="h-72"><canvas id="grafEstado" class="w-full h-full"></canvas></div>
      </div>

      <div class="bg-white shadow rounded-xl p-4">
        <h2 class="font-semibold mb-4 text-center">Topâ€‘5 usuarios con mÃ¡s prÃ©stamos</h2>
        <div class="h-72"><canvas id="grafTop" class="w-full h-full"></canvas></div>
      </div>
    </section>

    <!-- ---------- Tabla de prÃ©stamos ---------- -->
    <section class="bg-white shadow rounded-xl p-4">
      <h2 class="font-semibold mb-4 text-center">Historial de prÃ©stamos</h2>
      <table id="tblLoans" class="display w-full text-sm"></table>
    </section>
  </main>

  <!-- --------------- JS ---------------- -->
  <script type="module">
    import { SUPABASE_URL, HEADERS } from './assets/supa.js';
    import { alertError, alertInfo,
             alertConfirm, showLoader, closeLoader } from './assets/alert.js';
    import { getSession, clearSession } from './assets/session.js';

    /* ---------- SesiÃ³n protegida ---------- */
    let usuario = getSession();
    /* fallback: si no existe token aÃºn pero quedÃ³ el objeto antiguo */
    if (!usuario) {
      try { usuario = JSON.parse(localStorage.getItem('usuario')); }
      catch { /* nada */ }
    }
    if (!usuario) location = 'index.html';

    window.addEventListener('DOMContentLoaded', cargar);

    async function cargar () {
      document.getElementById('saludo').textContent = usuario.email ?? 'Invitado';
      showLoader('Cargando dashboardâ€¦');

      /* Peticiones paralelas */
      const rPlata  = fetch(`${SUPABASE_URL}/rest/v1/rpc/fn_stock_plataformas`,
                            { method:'POST', headers: HEADERS, body:'{}' });
      const rGenero = fetch(`${SUPABASE_URL}/rest/v1/rpc/fn_stock_generos`,
                            { method:'POST', headers: HEADERS, body:'{}' });
      const rEstado = fetch(`${SUPABASE_URL}/rest/v1/rpc/fn_prestamos_estado`,
                            { method:'POST', headers: HEADERS, body:'{}' });
      const rTop    = fetch(`${SUPABASE_URL}/rest/v1/rpc/fn_top_usuarios`,
                            { method:'POST', headers: HEADERS, body:'{}' });
      const rTabla  = fetch(`${SUPABASE_URL}/rest/v1/vista_prestamos_detalle`,
                            { headers: { ...HEADERS, Prefer:'count=exact' }});

      const [resPl, resGn, resEs, resTop, resTb] =
            await Promise.all([rPlata, rGenero, rEstado, rTop, rTabla]);
      closeLoader();

      if (![resPl, resGn, resEs, resTop, resTb].every(r => r.ok))
        return alertError('Error cargando datos del dashboard');

      /* ---------- GrÃ¡fico 1 ---------- */
      const datosPl = await resPl.json();
      new Chart(grafPlata, {
        type : 'bar',
        data : {
          labels   : datosPl.map(d => d.nombre_plataforma),
          datasets : [{
            label           : 'Unidades',
            data            : datosPl.map(d => d.total),
            backgroundColor : 'rgba(59,130,246,0.5)',
            borderColor     : 'rgba(59,130,246,1)',
            borderWidth     : 1,
          }]
        },
        options : { responsive:true, maintainAspectRatio:false,
                    scales:{ y:{ beginAtZero:true } } }
      });

      /* ---------- GrÃ¡fico 2 ---------- */
      const datosGn = await resGn.json();
      new Chart(grafGenero, {
        type : 'doughnut',
        data : {
          labels   : datosGn.map(d => d.nombre_genero),
          datasets : [{ data: datosGn.map(d => d.total) }]
        },
        options : { responsive:true, maintainAspectRatio:false,
                    plugins:{ legend:{ position:'bottom' } } }
      });

      /* ---------- GrÃ¡fico 3 ---------- */
      const datosEs = await resEs.json();
      new Chart(grafEstado, {
        type : 'pie',
        data : {
          labels   : datosEs.map(d => d.status),
          datasets : [{ data: datosEs.map(d => d.qty) }]
        },
        options : { responsive:true, maintainAspectRatio:false,
                    plugins:{ legend:{ position:'bottom' } } }
      });

      /* ---------- GrÃ¡fico 4 ---------- */
      const datosTop = await resTop.json();
      new Chart(grafTop, {
        type : 'bar',
        data : {
          labels   : datosTop.map(d => d.nombre_usuario),
          datasets : [{
            label           : 'PrÃ©stamos',
            data            : datosTop.map(d => d.total_prestamos),
            backgroundColor : 'rgba(16,185,129,0.5)',
            borderColor     : 'rgba(16,185,129,1)',
            borderWidth     : 1,
          }]
        },
        options : { indexAxis:'y', responsive:true, maintainAspectRatio:false }
      });

      /* ---------- DataTable ---------- */
      const prestamos = await resTb.json();
      $('#tblLoans').DataTable({
        data: prestamos,
        columns: [
          { title:'Usuario',    data:'usuario' },
          { title:'Videojuego', data:'videojuego' },
          { title:'Prestado',   data:'fecha_prestamo',
            render:d => d ? dayjs(d).format('DD/MM/YYYY HH:mm') : '' },
          { title:'Devuelto',   data:'fecha_devolucion',
            render:d => d ? dayjs(d).format('DD/MM/YYYY HH:mm') : 'Pendiente' }
        ]
      });

      alertInfo('Dashboard listo');
    }

    /* --- Logout --- */
    document.getElementById('logout').onclick = async () => {
      if (await alertConfirm('Â¿Cerrar sesiÃ³n?')) {
        clearSession();      // limpia token + expiraciÃ³n
        localStorage.removeItem('usuario'); // legacy
        location = 'index.html';
      }
    };
  </script>
</body>
</html>
